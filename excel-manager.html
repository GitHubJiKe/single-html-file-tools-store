<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel åœ¨çº¿ç®¡ç†å·¥å…·</title>
    
    <!-- SheetJS ä¾èµ– (å…è´¹å¼€æº) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Handsontable ä¾èµ– (å…è´¹ç‰ˆ) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12.3.1/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12.3.1/dist/handsontable.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 60px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .upload-area.dragover {
            background: #e0e7ff;
            border-color: #4c51bf;
        }
        
        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 18px;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 14px;
            color: #6c757d;
        }
        
        #fileInput {
            display: none;
        }
        
        /* æ–‡ä»¶åˆ—è¡¨ */
        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .file-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .file-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .file-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            word-break: break-all;
        }
        
        .file-info {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            min-height: 44px;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        /* SpreadJS å®¹å™¨ */
        #spreadContainer {
            width: 100%;
            height: 600px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .editor-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .editor-actions {
            display: flex;
            gap: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* ç¼–è¾‘å™¨å·¥å…·æ  */
        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-box-editor {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 250px;
        }
        
        .search-input-editor {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .search-input-editor:focus {
            border-color: #667eea;
        }
        
        .toolbar-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-tool {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-tool:hover {
            background: #e9ecef;
            border-color: #667eea;
        }
        
        .btn-tool:active {
            transform: scale(0.95);
        }
        
        .toolbar-divider {
            color: #ced4da;
            margin: 0 4px;
        }
        
        /* åŠ è½½æç¤º */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(102, 126, 234, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .loading-hint {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .nav-tab {
                padding: 12px 10px;
                font-size: 14px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .file-list {
                grid-template-columns: 1fr;
            }
            
            #spreadContainer {
                height: 400px;
            }
            
            .editor-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .editor-actions {
                flex-direction: column;
            }
            
            .editor-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box-editor {
                min-width: 100%;
            }
            
            .toolbar-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .btn-tool {
                font-size: 12px;
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- åŠ è½½æç¤º -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨åŠ è½½ Excel å¤„ç†åº“...</div>
        <div class="loading-hint">é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Excel åœ¨çº¿ç®¡ç†å·¥å…·</h1>
            <p>æ”¯æŒ Excel æ–‡ä»¶ä¸Šä¼ ã€åœ¨çº¿ç¼–è¾‘ã€æœ¬åœ°ç¼“å­˜ç®¡ç†</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="upload">ä¸Šä¼ æ–‡ä»¶</button>
            <button class="nav-tab" data-tab="list">æ–‡ä»¶åˆ—è¡¨</button>
            <button class="nav-tab" data-tab="editor">åœ¨çº¿ç¼–è¾‘</button>
        </div>
        
        <!-- ä¸Šä¼ é¡µé¢ -->
        <div class="tab-content active" id="upload">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  Excel æ–‡ä»¶</div>
                <div class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</div>
                <input type="file" id="fileInput" accept=".xlsx,.xls" multiple>
            </div>
        </div>
        
        <!-- æ–‡ä»¶åˆ—è¡¨é¡µé¢ -->
        <div class="tab-content" id="list">
            <div class="file-list" id="fileList"></div>
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">ğŸ“‚</div>
                <p>æš‚æ— æ–‡ä»¶ï¼Œè¯·å…ˆä¸Šä¼  Excel æ–‡ä»¶</p>
            </div>
        </div>
        
        <!-- ç¼–è¾‘å™¨é¡µé¢ -->
        <div class="tab-content" id="editor">
            <div class="editor-header" id="editorHeader" style="display: none;">
                <div class="editor-title" id="editorTitle">æœªæ‰“å¼€æ–‡ä»¶</div>
                <div class="editor-actions">
                    <button class="btn btn-success" id="saveBtn">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn btn-primary" id="downloadBtn">â¬‡ï¸ ä¸‹è½½</button>
                    <button class="btn btn-danger" id="closeBtn">âœ• å…³é—­</button>
                </div>
            </div>
            
            <!-- æœç´¢å’Œå·¥å…·æ  -->
            <div class="editor-toolbar" id="editorToolbar" style="display: none;">
                <div class="search-box-editor">
                    <input type="text" id="searchInput" class="search-input-editor" placeholder="æœç´¢å•å…ƒæ ¼å†…å®¹... (Ctrl+F)">
                    <button class="btn-tool" id="searchBtn" title="æœç´¢">ğŸ”</button>
                    <button class="btn-tool" id="clearSearchBtn" title="æ¸…é™¤æœç´¢">âœ•</button>
                </div>
                <div class="toolbar-actions">
                    <button class="btn-tool" id="undoBtn" title="æ’¤é”€ (Ctrl+Z)">â†¶</button>
                    <button class="btn-tool" id="redoBtn" title="é‡åš (Ctrl+Y)">â†·</button>
                    <span class="toolbar-divider">|</span>
                    <button class="btn-tool" id="addRowBtn" title="æ·»åŠ è¡Œ">â• è¡Œ</button>
                    <button class="btn-tool" id="addColBtn" title="æ·»åŠ åˆ—">â• åˆ—</button>
                    <span class="toolbar-divider">|</span>
                    <button class="btn-tool" id="filterBtn" title="å¯ç”¨è¿‡æ»¤å™¨">ğŸ”½ è¿‡æ»¤</button>
                </div>
            </div>
            
            <div id="spreadContainer"></div>
            <div class="empty-state" id="editorEmpty">
                <div class="empty-icon">ğŸ“</div>
                <p>è¯·ä»æ–‡ä»¶åˆ—è¡¨ä¸­é€‰æ‹©è¦ç¼–è¾‘çš„æ–‡ä»¶</p>
            </div>
        </div>
    </div>

    <script>
        // IndexedDB ç®¡ç†ç±»
        class ExcelDB {
            constructor() {
                this.dbName = 'ExcelManagerDB';
                this.storeName = 'files';
                this.db = null;
            }
            
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const objectStore = db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                            objectStore.createIndex('name', 'name', { unique: false });
                            objectStore.createIndex('uploadDate', 'uploadDate', { unique: false });
                        }
                    };
                });
            }
            
            async saveFile(name, data, size) {
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const objectStore = transaction.objectStore(this.storeName);
                
                const file = {
                    name: name,
                    data: data,
                    size: size,
                    uploadDate: new Date().toISOString()
                };
                
                return new Promise((resolve, reject) => {
                    const request = objectStore.add(file);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getAllFiles() {
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const objectStore = transaction.objectStore(this.storeName);
                
                return new Promise((resolve, reject) => {
                    const request = objectStore.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getFile(id) {
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const objectStore = transaction.objectStore(this.storeName);
                
                return new Promise((resolve, reject) => {
                    const request = objectStore.get(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async updateFile(id, data) {
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const objectStore = transaction.objectStore(this.storeName);
                
                return new Promise((resolve, reject) => {
                    const getRequest = objectStore.get(id);
                    getRequest.onsuccess = () => {
                        const file = getRequest.result;
                        file.data = data;
                        file.uploadDate = new Date().toISOString();
                        
                        const updateRequest = objectStore.put(file);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = () => reject(updateRequest.error);
                    };
                    getRequest.onerror = () => reject(getRequest.error);
                });
            }
            
            async deleteFile(id) {
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const objectStore = transaction.objectStore(this.storeName);
                
                return new Promise((resolve, reject) => {
                    const request = objectStore.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }
        
        // åº”ç”¨ç®¡ç†ç±»
        class ExcelManager {
            constructor() {
                this.db = new ExcelDB();
                this.hot = null;
                this.workbook = null;
                this.currentFileId = null;
                this.currentFileName = '';
                this.init();
            }
            
            async init() {
                await this.db.init();
                this.initHandsontable();
                this.bindEvents();
                await this.loadFileList();
            }
            
            initHandsontable() {
                // æ£€æŸ¥ Handsontable æ˜¯å¦åŠ è½½å®Œæˆ
                if (typeof Handsontable === 'undefined') {
                    console.error('Handsontable åº“æœªåŠ è½½å®Œæˆ');
                    alert('Excel å¤„ç†åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
                
                const container = document.getElementById('spreadContainer');
                this.hot = new Handsontable(container, {
                    data: [[]],
                    rowHeaders: true,
                    colHeaders: true,
                    height: 600,
                    width: '100%',
                    licenseKey: 'non-commercial-and-evaluation',
                    
                    // ç¼–è¾‘åŠŸèƒ½
                    allowInsertRow: true,
                    allowInsertColumn: true,
                    allowRemoveRow: true,
                    allowRemoveColumn: true,
                    
                    // ä¸Šä¸‹æ–‡èœå• - å¯ç”¨å®Œæ•´åŠŸèƒ½
                    contextMenu: {
                        items: {
                            'row_above': { name: 'åœ¨ä¸Šæ–¹æ’å…¥è¡Œ' },
                            'row_below': { name: 'åœ¨ä¸‹æ–¹æ’å…¥è¡Œ' },
                            'col_left': { name: 'åœ¨å·¦ä¾§æ’å…¥åˆ—' },
                            'col_right': { name: 'åœ¨å³ä¾§æ’å…¥åˆ—' },
                            'remove_row': { name: 'åˆ é™¤è¡Œ' },
                            'remove_col': { name: 'åˆ é™¤åˆ—' },
                            'sp1': '---------',
                            'undo': { name: 'æ’¤é”€' },
                            'redo': { name: 'é‡åš' },
                            'sp2': '---------',
                            'make_read_only': { name: 'åªè¯»' },
                            'alignment': { name: 'å¯¹é½æ–¹å¼' },
                            'sp3': '---------',
                            'cut': { name: 'å‰ªåˆ‡' },
                            'copy': { name: 'å¤åˆ¶' },
                            'paste': { name: 'ç²˜è´´' }
                        }
                    },
                    
                    // å¯ç”¨è¿‡æ»¤å™¨
                    filters: true,
                    dropdownMenu: true,
                    
                    // å¯ç”¨æœç´¢
                    search: true,
                    
                    // åˆ—è°ƒæ•´
                    manualColumnResize: true,
                    manualRowResize: true,
                    manualColumnMove: true,
                    manualRowMove: true,
                    
                    // è‡ªåŠ¨å¡«å……ï¼ˆæ‹–æ‹½å¤åˆ¶ï¼‰
                    fillHandle: true,
                    
                    // æ’¤é”€/é‡åš
                    undo: true,
                    
                    // è‡ªåŠ¨è¡Œåˆ—
                    minSpareRows: 1,
                    minSpareCols: 1,
                    
                    // å¤šé€‰
                    selectionMode: 'multiple',
                    
                    // å¯ç”¨å‰ªè´´æ¿
                    copyPaste: true
                });
            }
            
            bindEvents() {
                // æ ‡ç­¾åˆ‡æ¢
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        this.switchTab(tabName);
                    });
                });
                
                // æ–‡ä»¶ä¸Šä¼ 
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                uploadArea.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => this.handleFileUpload(e.target.files));
                
                // æ‹–æ‹½ä¸Šä¼ 
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    this.handleFileUpload(e.dataTransfer.files);
                });
                
                // ç¼–è¾‘å™¨æŒ‰é’®
                document.getElementById('saveBtn').addEventListener('click', () => this.saveCurrentFile());
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadCurrentFile());
                document.getElementById('closeBtn').addEventListener('click', () => this.closeEditor());
                
                // å·¥å…·æ æŒ‰é’®
                document.getElementById('searchBtn').addEventListener('click', () => this.searchInTable());
                document.getElementById('clearSearchBtn').addEventListener('click', () => this.clearSearch());
                document.getElementById('undoBtn').addEventListener('click', () => this.undo());
                document.getElementById('redoBtn').addEventListener('click', () => this.redo());
                document.getElementById('addRowBtn').addEventListener('click', () => this.addRow());
                document.getElementById('addColBtn').addEventListener('click', () => this.addColumn());
                document.getElementById('filterBtn').addEventListener('click', () => this.toggleFilters());
                
                // æœç´¢è¾“å…¥æ¡†å›è½¦æœç´¢
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.searchInTable();
                    }
                });
                
                // å¿«æ·é”®æ”¯æŒ
                document.addEventListener('keydown', (e) => {
                    // Ctrl+F æœç´¢
                    if (e.ctrlKey && e.key === 'f') {
                        e.preventDefault();
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput.offsetParent !== null) { // å¦‚æœæœç´¢æ¡†å¯è§
                            searchInput.focus();
                        }
                    }
                    // Ctrl+Z æ’¤é”€
                    if (e.ctrlKey && e.key === 'z' && !e.shiftKey && this.hot) {
                        e.preventDefault();
                        this.undo();
                    }
                    // Ctrl+Y æˆ– Ctrl+Shift+Z é‡åš
                    if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
                        if (this.hot) {
                            e.preventDefault();
                            this.redo();
                        }
                    }
                });
            }
            
            switchTab(tabName) {
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(tabName).classList.add('active');
                
                if (tabName === 'list') {
                    this.loadFileList();
                }
            }
            
            async handleFileUpload(files) {
                for (const file of files) {
                    if (!file.name.match(/\.(xlsx|xls)$/i)) {
                        alert('è¯·ä¸Šä¼  Excel æ–‡ä»¶ (.xlsx æˆ– .xls)');
                        continue;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const arrayBuffer = e.target.result;
                            await this.db.saveFile(file.name, arrayBuffer, file.size);
                            alert(`æ–‡ä»¶ "${file.name}" ä¸Šä¼ æˆåŠŸï¼`);
                            await this.loadFileList();
                        } catch (error) {
                            alert('æ–‡ä»¶ä¿å­˜å¤±è´¥ï¼š' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
                
                document.getElementById('fileInput').value = '';
            }
            
            async loadFileList() {
                const files = await this.db.getAllFiles();
                const fileList = document.getElementById('fileList');
                const emptyState = document.getElementById('emptyState');
                
                if (files.length === 0) {
                    fileList.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                fileList.innerHTML = files.map(file => `
                    <div class="file-item">
                        <div class="file-icon">ğŸ“„</div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-info">
                            å¤§å°: ${this.formatFileSize(file.size)}<br>
                            ä¸Šä¼ : ${new Date(file.uploadDate).toLocaleString('zh-CN')}
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-primary" onclick="app.openFile(${file.id})">æ‰“å¼€</button>
                            <button class="btn btn-success" onclick="app.exportFile(${file.id})">å¯¼å‡º</button>
                            <button class="btn btn-danger" onclick="app.deleteFile(${file.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            }
            
            async openFile(id) {
                try {
                    const file = await this.db.getFile(id);
                    if (!file) {
                        alert('æ–‡ä»¶ä¸å­˜åœ¨');
                        return;
                    }
                    
                    this.currentFileId = id;
                    this.currentFileName = file.name;
                    
                    // ä½¿ç”¨ SheetJS è§£æ Excel æ–‡ä»¶
                    const data = new Uint8Array(file.data);
                    this.workbook = XLSX.read(data, { type: 'array' });
                    
                    // è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const sheetName = this.workbook.SheetNames[0];
                    const worksheet = this.workbook.Sheets[sheetName];
                    
                    // è½¬æ¢ä¸ºäºŒç»´æ•°ç»„
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        defval: '',
                        raw: false 
                    });
                    
                    // åŠ è½½åˆ° Handsontable
                    this.hot.loadData(jsonData.length > 0 ? jsonData : [[]]);
                    
                    document.getElementById('editorTitle').textContent = file.name;
                    document.getElementById('editorHeader').style.display = 'flex';
                    document.getElementById('editorToolbar').style.display = 'flex';
                    document.getElementById('editorEmpty').style.display = 'none';
                    document.getElementById('spreadContainer').style.display = 'block';
                    
                    this.switchTab('editor');
                } catch (error) {
                    alert('æ‰“å¼€æ–‡ä»¶å¤±è´¥ï¼š' + error.message);
                    console.error(error);
                }
            }
            
            async saveCurrentFile() {
                if (!this.currentFileId) {
                    alert('æ²¡æœ‰æ‰“å¼€çš„æ–‡ä»¶');
                    return;
                }
                
                try {
                    // ä» Handsontable è·å–æ•°æ®
                    const data = this.hot.getData();
                    
                    // åˆ›å»ºæ–°çš„å·¥ä½œç°¿
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
                    
                    // ç”Ÿæˆ Excel æ–‡ä»¶
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    
                    // æ›´æ–°åˆ° IndexedDB
                    await this.db.updateFile(this.currentFileId, wbout);
                    
                    alert('ä¿å­˜æˆåŠŸï¼');
                    await this.loadFileList();
                } catch (error) {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
                    console.error(error);
                }
            }
            
            async downloadCurrentFile() {
                if (!this.currentFileId) {
                    alert('æ²¡æœ‰æ‰“å¼€çš„æ–‡ä»¶');
                    return;
                }
                
                try {
                    // ä» Handsontable è·å–æ•°æ®
                    const data = this.hot.getData();
                    
                    // åˆ›å»ºæ–°çš„å·¥ä½œç°¿
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
                    
                    // ç”Ÿæˆå¹¶ä¸‹è½½ Excel æ–‡ä»¶
                    XLSX.writeFile(wb, this.currentFileName || 'export.xlsx');
                } catch (error) {
                    alert('ä¸‹è½½å¤±è´¥ï¼š' + error.message);
                    console.error(error);
                }
            }
            
            async exportFile(id) {
                try {
                    const file = await this.db.getFile(id);
                    const blob = new Blob([file.data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
                }
            }
            
            async deleteFile(id) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                    return;
                }
                
                try {
                    await this.db.deleteFile(id);
                    alert('åˆ é™¤æˆåŠŸ');
                    
                    if (this.currentFileId === id) {
                        this.closeEditor();
                    }
                    
                    await this.loadFileList();
                } catch (error) {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
                }
            }
            
            closeEditor() {
                this.currentFileId = null;
                this.currentFileName = '';
                this.workbook = null;
                
                // æ¸…ç©º Handsontable æ•°æ®
                this.hot.loadData([[]]);
                
                document.getElementById('editorHeader').style.display = 'none';
                document.getElementById('editorToolbar').style.display = 'none';
                document.getElementById('editorEmpty').style.display = 'block';
                document.getElementById('spreadContainer').style.display = 'none';
            }
            
            // æœç´¢åŠŸèƒ½
            searchInTable() {
                const searchInput = document.getElementById('searchInput');
                const query = searchInput.value.trim();
                
                if (!query) {
                    alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
                    return;
                }
                
                const search = this.hot.getPlugin('search');
                const searchResult = search.query(query);
                
                if (searchResult.length > 0) {
                    // è·³è½¬åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
                    const firstResult = searchResult[0];
                    this.hot.selectCell(firstResult.row, firstResult.col);
                    
                    // é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
                    this.hot.render();
                    
                    alert(`æ‰¾åˆ° ${searchResult.length} ä¸ªåŒ¹é…é¡¹`);
                } else {
                    alert('æœªæ‰¾åˆ°åŒ¹é…å†…å®¹');
                }
            }
            
            // æ¸…é™¤æœç´¢
            clearSearch() {
                const search = this.hot.getPlugin('search');
                search.query('');
                document.getElementById('searchInput').value = '';
                this.hot.render();
            }
            
            // æ’¤é”€
            undo() {
                if (this.hot && this.hot.isUndoAvailable()) {
                    this.hot.undo();
                } else {
                    alert('æ— æ³•æ’¤é”€');
                }
            }
            
            // é‡åš
            redo() {
                if (this.hot && this.hot.isRedoAvailable()) {
                    this.hot.redo();
                } else {
                    alert('æ— æ³•é‡åš');
                }
            }
            
            // æ·»åŠ è¡Œ
            addRow() {
                const selected = this.hot.getSelected();
                if (selected && selected.length > 0) {
                    const row = selected[0][0];
                    this.hot.alter('insert_row', row + 1, 1);
                } else {
                    // åœ¨æœ«å°¾æ·»åŠ 
                    const rowCount = this.hot.countRows();
                    this.hot.alter('insert_row', rowCount, 1);
                }
            }
            
            // æ·»åŠ åˆ—
            addColumn() {
                const selected = this.hot.getSelected();
                if (selected && selected.length > 0) {
                    const col = selected[0][1];
                    this.hot.alter('insert_col', col + 1, 1);
                } else {
                    // åœ¨æœ«å°¾æ·»åŠ 
                    const colCount = this.hot.countCols();
                    this.hot.alter('insert_col', colCount, 1);
                }
            }
            
            // åˆ‡æ¢è¿‡æ»¤å™¨
            toggleFilters() {
                const filtersPlugin = this.hot.getPlugin('filters');
                
                if (filtersPlugin.enabled) {
                    filtersPlugin.clearConditions();
                    filtersPlugin.filter();
                    alert('å·²æ¸…é™¤æ‰€æœ‰è¿‡æ»¤å™¨');
                } else {
                    filtersPlugin.enablePlugin();
                    alert('è¿‡æ»¤å™¨å·²å¯ç”¨ï¼Œç‚¹å‡»åˆ—å¤´çš„ä¸‹æ‹‰ç®­å¤´è¿›è¡Œè¿‡æ»¤');
                }
                
                this.hot.render();
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        let app;
        // ä½¿ç”¨ window.load ç¡®ä¿æ‰€æœ‰å¤–éƒ¨è„šæœ¬åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // æ£€æŸ¥ä¾èµ–åº“æ˜¯å¦åŠ è½½
            if (typeof XLSX === 'undefined' || typeof Handsontable === 'undefined') {
                console.error('Excel å¤„ç†åº“åŠ è½½å¤±è´¥');
                loadingOverlay.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">âš ï¸</div>
                        <div style="font-size: 20px; margin-bottom: 10px;">ä¾èµ–åº“åŠ è½½å¤±è´¥</div>
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 20px;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>
                        <button onclick="location.reload()" style="padding: 12px 24px; font-size: 16px; border: 2px solid white; background: transparent; color: white; border-radius: 6px; cursor: pointer;">
                            åˆ·æ–°é¡µé¢
                        </button>
                    </div>
                `;
                return;
            }
            
            // åˆå§‹åŒ–åº”ç”¨
            app = new ExcelManager();
            
            // éšè—åŠ è½½æç¤º
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 500);
        });
    </script>
</body>
</html>

<!--
å·¥å…·å…ƒä¿¡æ¯ï¼š
- åˆ›å»ºæ—¥æœŸï¼š2025-12-26
- æœ€åæ›´æ–°ï¼š2025-12-26
- æ ¸å¿ƒåŠŸèƒ½ï¼šExcel æ–‡ä»¶åœ¨çº¿ç®¡ç†ã€ç¼–è¾‘ã€æœ¬åœ°ç¼“å­˜
- ä¾èµ–åº“ï¼š
  * SheetJS (xlsx) 0.18.5 - å…è´¹å¼€æº Excel æ–‡ä»¶è§£æåº“
  * Handsontable 12.3.1 - å…è´¹ç‰ˆç”µå­è¡¨æ ¼ç¼–è¾‘å™¨
- å­˜å‚¨æ–¹å¼ï¼šIndexedDB æœ¬åœ°å­˜å‚¨
- åŠŸèƒ½é™åˆ¶ï¼šä»…æ”¯æŒå•ä¸ªå·¥ä½œè¡¨ç¼–è¾‘ï¼Œä¸æ”¯æŒå›¾è¡¨ã€å½¢çŠ¶ç­‰é«˜çº§åŠŸèƒ½
- ç”Ÿæˆæç¤ºï¼šBuild an Excel online management tool with SheetJS, Handsontable, IndexedDB cache, free and open source, No React
- éµå¾ªè§„èŒƒï¼šSimon Willison å•æ–‡ä»¶ HTML å·¥å…·å¼€å‘è§„èŒƒ
-->